<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Order History - Book Bagaicha</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!--toastify css -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="../css/orderHistory.css" />
    <style>
        .status-completed {
            background-color: #DEBC40;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="HomePage.html">Book Bagaicha</a>
            <div class="d-flex align-items-center ms-auto">
                <ul class="navbar-nav me-4">
                    <li class="nav-item">
                        <a class="nav-link" href="HomePage.html">HOME</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="browseBooks.html">BOOKS</a>
                    </li>
                </ul>
                <div class="d-flex me-3">
                    <input class="form-control form-control-sm" type="search" placeholder="Search for products..." aria-label="Search" />
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuButton">
                            <li><a class="dropdown-item" href="userHome.html">User Profile</a></li>
                            <li><a class="dropdown-item" href="Wishlist.html">My Wishlist</a></li>
                            <li><a class="dropdown-item active" href="orderHistory.html">Order History</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
                        </ul>
                    </div>
                    <a href="cart.html" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-shopping-cart"></i>
                    </a>
                    <a href="orderHistory.html" class="btn btn-outline-light btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12 21q-3.15 0-5.575-1.912T3.275 14.2q-.1-.375.15-.687t.675-.363q.4-.05.725.15t.45.6q.6 2.25 2.475 3.675T12 19q2.925 0 4.963-2.037T19 12t-2.037-4.962T12 5q-1.725 0-3.225.8T6.25 8H8q.425 0 .713.288T9 9t-.288.713T8 10H4q-.425 0-.712-.288T3 9V5q0-.425.288-.712T4 4t.713.288T5 5v1.35q1.275-1.6 3.113-2.475T12 3q1.875 0 3.513.713t2.85 1.924t1.925 2.85T21 12t-.712 3.513t-1.925 2.85t-2.85 1.925T12 21m1-9.4l2.5 2.5q.275.275.275.7t-.275.7t-.7.275t-.7-.275l-2.8-2.8q-.15-.15-.225-.337T11 11.975V8q0-.425.288-.712T12 7t.713.288T13 8z" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>My Orders</h2>
                <p>For each 10 successfully completed orders, you get 10% discount on your next order.</p>
            </div>
            <a href="browseBooks.html" class="btn btn-outline-primary">
                <i class="fas fa-book me-2"></i>Continue Shopping
            </a>
        </div>

        <div id="ordersContainer">
            <!-- Loading spinner -->
            <div class="text-center py-5" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading your orders...</p>
            </div>
            <!--Orders displayed-->
        </div>
    </div>

    <!-- Order details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailsContent">
                    <!-- Order details displayed-->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading order details...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="cancelOrderBtn" data-order-id="">Cancel Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel order confirmation Dialog -->
    <div class="confirmation-dialog" id="cancelOrderDialog">
        <div class="confirmation-content">
            <i class="fas fa-exclamation-circle fa-3x text-warning mb-3"></i>
            <h4>Cancel Order</h4>
            <p>Are you sure you want to cancel this order? This action cannot be undone.</p>
            <div class="confirmation-actions">
                <button class="btn btn-secondary" id="cancelCancelBtn">No, Keep Order</button>
                <button class="btn btn-danger" id="confirmCancelBtn">Yes, Cancel Order</button>
            </div>
        </div>
    </div>

    <!-- Order cancelled success Dialog -->
    <div class="confirmation-dialog" id="cancelSuccessDialog">
        <div class="confirmation-content">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h4>Order Cancelled</h4>
            <p>Your order has been successfully cancelled.</p>
            <div class="confirmation-actions">
                <button class="btn btn-primary" id="okBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Error Dialog -->
    <div class="confirmation-dialog" id="errorDialog">
        <div class="confirmation-content">
            <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
            <h4 id="errorTitle">Error</h4>
            <p id="errorMessage">An error occurred. Please try again later.</p>
            <div class="confirmation-actions">
                <button class="btn btn-primary" id="errorOkBtn">OK</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addReviewModal" tabindex="-1" aria-labelledby="addReviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addReviewModalLabel">Add Your Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reviewBookId">
                    <input type="hidden" id="reviewOrderItemId">
                    <div class="mb-3">
                        <label for="rating" class="form-label">Rating:</label>
                        <select class="form-select" id="rating">
                            <option value="1">1 - Poor</option>
                            <option value="2">2 - Fair</option>
                            <option value="3">3 - Average</option>
                            <option value="4">4 - Good</option>
                            <option value="5">5 - Excellent</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Comments:</label>
                        <textarea class="form-control" id="comment" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="submitReviewBtn">Submit Review</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        $(document).ready(function () {
            // Check if user is logged in
            if (!isUserLoggedIn()) {
                localStorage.setItem('redirectAfterLogin', window.location.href);
                // Redirect to login page
                window.location.href = 'login.html';
                return;
            }

            // Initialize modal
            const orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            const addReviewModal = new bootstrap.Modal(document.getElementById('addReviewModal'));

            // Load orders
            loadOrders();

            // Function to check if user is logged in
            function isUserLoggedIn() {
                return localStorage.getItem('authToken') !== null;
            }

            // Function to load orders
            async function loadOrders() {
                try {
                    $('#loadingSpinner').show();
                    console.log("Fetching orders...");

                    const response = await fetch('/api/order/getAllOrder', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    console.log("API response status:", response.status);

                    if (response.ok) {
                        const data = await response.json();
                        console.log("Orders API response data:", data);

                        let orders = [];
                        if (Array.isArray(data)) {
                            console.log("Response is an array");
                            orders = data;
                        } else if (data && typeof data === 'object') {
                            console.log("Response is an object");
                            if (data.orders && Array.isArray(data.orders)) {
                                console.log("Found orders array in data.orders");
                                orders = data.orders;
                            } else if (data.$values && Array.isArray(data.$values)) {
                                console.log("Found orders array in data.$values");
                                orders = data.$values;
                            } else if (data.items && Array.isArray(data.items)) {
                                console.log("Found orders array in data.items");
                                orders = data.items;
                            } else if (data.orderId) {
                                console.log("Found a single order");
                                orders = [data];
                            } else {
                                console.warn("No recognizable orders data structure found");
                            }
                        }

                        console.log("Processed orders:", orders);

                        if (!orders || orders.length === 0) {
                            console.warn("No orders found in the response data");
                        }

                        displayOrders(orders);
                        updateLoyaltyStatus(orders);
                    } else {
                        await handleApiError(response);
                    }
                } catch (error) {
                    console.error('Error loading orders:', error);
                    showToastMessage("An error occurred while loading your orders.", "error");

                    // Show empty state with error message
                    $('#ordersContainer').html(`
                                                <div class="alert alert-danger" role="alert">
                                                    <i class="fas fa-exclamation-circle me-2"></i>
                                                    Failed to load your orders. Please try again later.
                                                </div>
                                                <div class="text-center mt-3">
                                                    <button class="btn btn-primary" onclick="window.location.reload()">Retry</button>
                                                </div>
                                            `);
                } finally {
                    // Hide loading spinner
                    $('#loadingSpinner').hide();
                }
            }

            // Function to update loyalty status
            function updateLoyaltyStatus(orders) {
                try {
                    // Count only confirmed orders
                    const confirmedOrders = orders.filter(order => order.status === 'Confirmed').length;

                    if (confirmedOrders >= 10) {
                        $('#loyaltyStatus').html(`
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-crown me-1"></i> Loyal Customer: ${confirmedOrders} successful orders
                                                    </span>
                                                    <span class="ms-2 text-success">
                                                        <i class="fas fa-tag"></i> You get 10% discount on your orders!
                                                    </span>
                                                `);
                    } else {
                        const ordersNeeded = 10 - confirmedOrders;
                        $('#loyaltyStatus').html(`
                                                    <span>
                                                        <i class="fas fa-info-circle me-1"></i> Place ${ordersNeeded} more order${ordersNeeded !== 1 ? 's' : ''} to get a 10% loyalty discount!
                                                    </span>
                                                `);
                    }
                } catch (error) {
                    console.error('Error updating loyalty status:', error);
                }
            }

            // Function to display orders
            function displayOrders(orders) {
                const ordersContainer = $('#ordersContainer');
                ordersContainer.empty(); 

                if (!orders || orders.length === 0) {
                    // Display empty orders message
                    ordersContainer.html(`
                                              <div class="empty-orders">
                                                    <i class="fas fa-shopping-bag"></i>
                                                    <h4>No Orders Yet</h4>
                                                    <p class="text-muted">You haven't placed any orders yet.</p>
                                                    <a href="browseBooks.html" class="btn btn-primary mt-3">Start Shopping</a>
                                                </div>
                                            `);
                    return;
                }

                // Sort orders by date asc
                orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

                // Create orders list
                orders.forEach(order => {
                    const orderDate = new Date(order.orderDate).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    let statusClass = 'status-cancelled'; 
                    if (order.status === 'Confirmed') {
                        statusClass = 'status-confirmed'; 
                    } else if (order.status === 'Completed') {
                        statusClass = 'status-completed'; 
                    }

                    const orderCard = $(`
                                                <div class="order-card position-relative">
                                                    <div class="order-header d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h5 class="mb-1">Order #${order.claimCode}</h5>
                                                            <p class="text-muted mb-0">${orderDate}</p>
                                                        </div>
                                                        <span class="status-badge ${statusClass}">${order.status}</span>
                                                    </div>
                                                    <div class="order-footer d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <p class="mb-0"><strong>${order.itemCount}</strong> item${order.itemCount !== 1 ? 's' : ''} • <strong>Rs. ${order.totalPrice.toFixed(2)}</strong></p>
                                                        </div>
                                                        <button class="btn btn-outline-primary btn-sm view-details-btn" data-order-id="${order.orderId}">
                                                            View Details
                                                        </button>
                                                    </div>
                                                </div>
                                            `);

                    ordersContainer.append(orderCard);
                });

                //event listeners for view details buttons
                $('.view-details-btn').on('click', function () {
                    const orderId = $(this).data('order-id');
                    loadOrderDetails(orderId);
                });
            }

            // Function to load order details
            async function loadOrderDetails(orderId) {
                try {
                    // Show modals
                    orderDetailsModal.show();
                    $('#orderDetailsContent').html(`
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2">Loading order details...</p>
                                                </div>
                                            `);

                    // Update cancel button with order ID
                    $('#cancelOrderBtn').data('order-id', orderId);

                    console.log("Fetching details for order ID:", orderId);
                    const response = await fetch(`/api/order/getOrderDetails/${orderId}/orderitems`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    console.log("Order details API response status:", response.status);

                    if (response.ok) {
                        const orderDetails = await response.json();
                        console.log("Order details API response data:", orderDetails);
                        displayOrderDetails(orderDetails);
                    } else {
                        await handleApiError(response);
                        orderDetailsModal.hide();
                    }
                } catch (error) {
                    console.error('Error loading order details:', error);
                    showToastMessage("An error occurred while loading order details.", "error");
                    orderDetailsModal.hide();

                    // Show error dialog
                    showErrorDialog("Failed to Load Order Details", "Could not retrieve the order details. Please try again later.");
                }
            }

            // Function to display order details
            function displayOrderDetails(order) {
                const orderDate = new Date(order.orderDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let statusClass = 'status-cancelled'; //default red

                if (order.status === 'Confirmed') {
                    statusClass = 'status-confirmed'; //confirmed green
                } else if (order.status === 'Completed') {
                    statusClass = 'status-completed'; //completed yellow
                }


                // Update modal title
                $('#orderDetailsModalLabel').text(`Order #${order.claimCode}`);

                // Create order details content
                const orderDetailsContent = $(`
                                            <div>
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <div>
                                                        <p class="mb-1"><strong>Order Date:</strong> ${orderDate}</p>
                                                        <p class="mb-0"><strong>Status:</strong> <span class="status-badge ${statusClass}">${order.status}</span></p>
                                                    </div>
                                                    <div class="text-end">
                                                        <p class="mb-1"><strong>Total:</strong> Rs. ${order.totalPrice.toFixed(2)}</p>
                                                        ${order.appliedDiscount > 0 ? `<p class="mb-0 text-success"><strong>Discount Applied:</strong> Rs. ${order.appliedDiscount.toFixed(2)}</p>` : ''}
                                                    </div>
                                                </div>
                                                <h5 class="mb-3">Order Items</h5>
                                                <div class="order-items">
                                                    <!-- Order items will be added here -->
                                                </div>
                                            </div>
                                        `);

                // Add order items
                const orderItemsContainer = orderDetailsContent.find('.order-items');

                // Check for items 
                let items = [];
                if (order.items && Array.isArray(order.items)) {
                    items = order.items;
                } else if (order.items && order.items.$values && Array.isArray(order.items.$values)) {
                    items = order.items.$values;
                } else if (order.orderItems && Array.isArray(order.orderItems)) {
                    items = order.orderItems;
                } else if (order.orderItems && order.orderItems.$values && Array.isArray(order.orderItems.$values)) {
                    items = order.orderItems.$values;
                }

                console.log("Order items for display:", items);

                if (items.length > 0) {
                    items.forEach(item => {
                        // Handle missing data 
                        const imageUrl = item.image ? `../${item.image}` : 'https://via.placeholder.com/80x120?text=No+Image';

                        // Handle authors 
                        let authors = 'Unknown';
                        if (item.authors && Array.isArray(item.authors)) {
                            authors = item.authors.join(', ');
                        } else if (item.authors && item.authors.$values && Array.isArray(item.authors.$values)) {
                            authors = item.authors.$values.map(a => {
                                if (typeof a === 'string') return a;
                                return `${a.firstName || ''} ${a.lastName || ''}`.trim();
                            }).join(', ');
                        } else if (item.book && item.book.authors) {
                            if (Array.isArray(item.book.authors)) {
                                authors = item.book.authors.join(', ');
                            } else if (item.book.authors.$values && Array.isArray(item.book.authors.$values)) {
                                authors = item.book.authors.$values.map(a => {
                                    if (typeof a === 'string') return a;
                                    return `${a.firstName || ''} ${a.lastName || ''}`.trim();
                                }).join(', ');
                            }
                        }

                        // Get book title
                        const bookTitle = item.bookTitle || (item.book ? item.book.title : 'Unknown Book');

                        // Get price 
                        const price = item.priceAtPurchase || item.price || (item.book ? item.book.price : 0);

                        // Get quantity
                        const quantity = item.quantity || 1;

                        const itemElement = $(`
                                                    <div class="order-item">
                                                        <div class="row">
                                                            <div class="col-md-8 d-flex">
                                                                <img src="${imageUrl}" class="book-img me-3" alt="${bookTitle}">
                                                                <div>
                                                                    <h6 class="mb-1">${bookTitle}</h6>
                                                                    <p class="text-muted small mb-1">${authors}</p>
                                                                    <p class="mb-0">Rs. ${price.toFixed(2)} × ${quantity}</p>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4 text-md-end">
                                                                <h6 class="mt-3 mt-md-0">Rs. ${(price * quantity).toFixed(2)}</h6>
                                                                ${order.status === 'Completed' ? `<button class="btn btn-sm btn-outline-success mt-2 add-review-btn" data-book-id="${item.bookId}" data-order-item-id="${item.orderItemId}">Add Review</button>` : ''}

                                                            </div>
                                                        </div>
                                                    </div>
                                                `);

                        orderItemsContainer.append(itemElement);
                        itemElement.find('.add-review-btn').on('click', function () {
                            console.log('Add Review button clicked!');
                            const bookId = $(this).data('book-id');
                            const orderItemId = $(this).data('order-item-id');

                            // Store bookId and orderItemId 
                            $('#reviewBookId').val(bookId);
                            $('#reviewOrderItemId').val(orderItemId);

                            //add review modal
                            addReviewModal.show();
                        });
                    });


                } else {
                    // Handle case with no items
                    orderItemsContainer.html(`
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    No items found in this order.
                                                </div>
                                            `);
                }

                // Update modal content
                $('#orderDetailsContent').html(orderDetailsContent);

                // Show or hide cancel button based on order status
                if (order.status === 'Confirmed') {
                    $('#cancelOrderBtn').show();
                } else {
                    $('#cancelOrderBtn').hide();
                }
            }
            $('#submitReviewBtn').on('click', async function () {
                const bookId = $('#reviewBookId').val();
                const orderItemId = $('#reviewOrderItemId').val();
                const rating = $('#rating').val();
                const comment = $('#comment').val();

                const reviewData = {
                    bookId: bookId,
                    ratings: parseInt(rating),
                    comments: comment
                };

                try {
                    const response = await fetch('/api/Review/addReview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(reviewData)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log("Review submitted successfully:", data);
                        showToastMessage("Review submitted successfully!", "success");
                        addReviewModal.hide();
                    } else if (response.status === 409) {
                        const errorData = await response.json();
                        console.warn("Review submission conflict:", errorData);
                        showToastMessage(errorData?.message || "You have already reviewed this book.", "warning");
                        addReviewModal.hide();
                    } else {
                        const errorData = await response.json();
                        console.error("Error submitting review:", errorData);
                        showToastMessage(`Failed to submit review: ${errorData?.message || response.statusText}`, "error");
                    }
                } catch (error) {
                    console.error("Error submitting review:", error);
                    showToastMessage("Failed to submit review. Please try again later.", "error");
                }
            });

            // Function to show error dialog
            function showErrorDialog(title, message) {
                $('#errorTitle').text(title || 'Error');
                $('#errorMessage').text(message || 'An error occurred. Please try again later.');
                $('#errorDialog').addClass('active');
            }

            // Error dialog OK button
            $('#errorOkBtn').on('click', function () {
                $('#errorDialog').removeClass('active');
            });

            // Cancel Order button
            $('#cancelOrderBtn').on('click', function () {
                const orderId = $(this).data('order-id');
                $('#confirmCancelBtn').data('order-id', orderId);
                $('#cancelOrderDialog').addClass('active');
            });

            // Cancel confirmation buttons
            $('#cancelCancelBtn').on('click', function () {
                $('#cancelOrderDialog').removeClass('active');
            });

            $('#confirmCancelBtn').on('click', async function () {
                try {
                   
                    $(this).prop('disabled', true);
                    $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...');

                    const orderId = $(this).data('order-id');
                    console.log("Cancelling order ID:", orderId);

                    // Call API to cancel order
                    const response = await fetch(`/api/order/cancelOrder/${orderId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    console.log("Cancel order API response status:", response.status);

                    if (response.ok) {
                        // Hide cancel confirmation dialog
                        $('#cancelOrderDialog').removeClass('active');
                        orderDetailsModal.hide();

                        // Success dialog 
                        setTimeout(() => {


                            $('#cancelSuccessDialog').addClass('active');

                            // Update order status 
                            $(`.view-details-btn[data-order-id="${orderId}"]`)
                                .closest('.order-card')
                                .find('.status-badge')
                                .removeClass('status-confirmed')
                                .addClass('status-cancelled')
                                .text('Cancelled');

                        }, 500);

                    } else {
                        await handleApiError(response);
                        $('#cancelOrderDialog').removeClass('active');
                    }
                } catch (error) {
                    console.error('Error cancelling order:', error);
                    showToastMessage("An unexpected error occurred", "error");
                    $('#cancelOrderDialog').removeClass('active');

                    // Show error dialog
                    showErrorDialog("Failed to Cancel Order", "The order could not be cancelled at this time. Please try again later.");
                } finally {
                    // Reset button state
                    $('#confirmCancelBtn').prop('disabled', false);
                    $('#confirmCancelBtn').html('Yes, Cancel Order');
                }
            });

            // Success dialog OK button
            $('#okBtn').on('click', function () {
                $('#cancelSuccessDialog').removeClass('active');
            });

            // Handle API errors
            async function handleApiError(response) {
                console.log("Handling API error, status:", response.status);

                if (response.status === 401) {
                    // Unauthorized token expired
                    showToastMessage("Your session has expired. Please login again.", "error");
                    handleSessionExpired();
                    return;
                }

                if (response.status === 404) {
                    // Not found 
                    showToastMessage("The requested order was not found.", "error");
                    return;
                }

                if (response.status === 500) {
                    // Server error
                    showToastMessage("The server encountered an error. Please try again later.", "error");
                    console.error("Server returned 500 error - check that IOrderService is registered correctly");
                    return;
                }

                try {
                    // Try to parse error message from response
                    const errorData = await response.json();
                    console.log("Error data:", errorData);
                    showToastMessage(errorData.message || "An error occurred", "error");
                } catch (e) {
                    // If response is not JSON
                    console.log("Failed to parse error JSON:", e);
                    showToastMessage(`Error ${response.status}: ${response.statusText || "An error occurred"}`, "error");
                }
            }

            // Function to handle session expired
            function handleSessionExpired() {
                // Clear token and redirect to login
                localStorage.removeItem('authToken');
                localStorage.setItem('redirectAfterLogin', window.location.href);

                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }

            // Function to display toast msgs
            function showToastMessage(message, type = 'success') {
                const backgroundColor = type === 'success'
                    ? "linear-gradient(to right, #00b09b, #96c93d)"
                    : "#dc3545";

                Toastify({
                    text: message,
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: backgroundColor,
                    }
                }).showToast();
            }
            // Logout button
            $('#logoutBtn').on('click', function (e) {
                e.preventDefault();

                // Clear authentication token and other data
                localStorage.removeItem('authToken');
                localStorage.removeItem('cartId');

                showToastMessage("Logged out successfully!");

                // Redirect to login page 
                setTimeout(function () {
                    window.location.href = 'login.html';
                }, 1000);
            });
        });
    </script>
    <!--Import cart and web socket scripts-->
    <script src="../js/cart.js"></script>
    <script src="../js/webSocketCustomer.js"></script>

</body>
</html>