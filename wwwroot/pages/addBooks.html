<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bona+Nova:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/adminNav.css" />
    <title>Add book</title>
  </head>
  <body>
      <div class="container-fluid">
          <div class="row">
              <div class="col-md-3">
                  <ul class="nav flex-column adminNav">
                      <li class="nav-item">
                          <a class="nav-link p-1 navLogo bona-nova-regular">
                              Book Bagaicha
                          </a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="adminDashboard.html">Dashboard</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="adduser.html">Staff</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link active" href="addBooks.html">Books</a>
                      </li>
                      <li class="nav-item">
                          <a class="nav-link" href="#">Logout</a>
                      </li>
                  </ul>
              </div>
              <div class="col-md-9 p-3">
                  <div class="page-header d-flex mb-3">
                      <div class="greet">
                          <h3>Hello Admin!</h3>
                          <span class="text-muted"> Have a nice day</span>
                      </div>
                      <div class="profileSection d-flex align-items-center">
                          <div class="profileImage"></div>
                          <div class="profileDetails">
                              <h6>UserName</h6>
                              <span class="text-muted">Book Bagaicha</span>
                          </div>
                      </div>
                  </div>
                  <div class="row">
                      <div class="col-md-12 mt-3 px-5">
                          <div class="row py-3">
                              <div class="col-md-12 d-flex searchHead px-4">
                                  <input type="text"
                                         placeholder="Search book"
                                         class="search p-1" />
                                  <select class="sort p-1">
                                      <option>Sort By: &nbsp;</option>
                                      <option>By Date</option>
                                  </select>
                                  <div class="filterIcon align-self-center">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                          <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="1.5" d="M21.25 12H8.895m-4.361 0H2.75m18.5 6.607h-5.748m-4.361 0H2.75m18.5-13.214h-3.105m-4.361 0H2.75m13.214 2.18a2.18 2.18 0 1 0 0-4.36a2.18 2.18 0 0 0 0 4.36Zm-9.25 6.607a2.18 2.18 0 1 0 0-4.36a2.18 2.18 0 0 0 0 4.36Zm6.607 6.608a2.18 2.18 0 1 0 0-4.361a2.18 2.18 0 0 0 0 4.36Z" />
                                      </svg>
                                  </div>
                              </div>
                          </div>
                          <div class="row">
                              <div class="col-md-12">
                                  <div class="d-flex justify-content-between p-4">
                                      <h5>Books List</h5>
                                      <button type="button" class="primaryBtn" data-toggle="modal" data-target="#bookModal">
                                          Add Book
                                      </button>
                                  </div>
                                  <div class="bookTable">
                                      <table class="table">
                                          <thead>
                                              <tr>
                                                  <th>ID</th>
                                                  <th>Title</th>
                                                  <th>Summary</th>
                                                  <th>ISBN</th>
                                                  <th>Price</th>
                                                  <th>Language</th>
                                                  <th>Format</th>
                                                  <th>Publication Date</th>
                                                  <th>Quantity</th>
                                                  <th>On Sale</th>
                                                  <th>Sale Percntage</th>
                                                  <th>Sale Start Date</th>
                                                  <th>Category</th>
                                                  <th>Image</th>
                                                  <th>Publisher</th>
                                                  <th>Authors</th>
                                                  <th>Genres</th>
                                                  <th>Actions</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                              <tr>
                                                  <td>ID</td>
                                                  <td>Title</td>
                                                  <td>Summary</td>
                                                  <td>ISBN</td>
                                                  <td>Price</td>
                                                  <td>Language</td>
                                                  <td>Format</td>
                                                  <td>Publication Date</td>
                                                  <td>Quantity</td>
                                                  <td>On Sale</td>
                                                  <td>Sale Percntage</td>
                                                  <td>Sale Start Date</td>
                                                  <td>Category</td>
                                                  <td>Image</td>
                                                  <td>Publisher</td>
                                                  <td>Authors</td>
                                                  <td>Genres</td>
                                                  <td class="actionBtns d-flex justify-content-between">
                                                      <button class="edit-Btn">
                                                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                                              <path fill="currentColor" d="M15.748 2.947a2 2 0 0 1 2.828 0l2.475 2.475a2 2 0 0 1 0 2.829L9.158 20.144l-6.38 1.076l1.077-6.38zm-.229 3.057l2.475 2.475l1.643-1.643l-2.475-2.474zm1.06 3.89l-2.474-2.475l-8.384 8.384l-.503 2.977l2.977-.502z"
                                                                    stroke-width="1" stroke="currentColor" />
                                                          </svg>
                                                      </button>
                                                      <button>
                                                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                                              <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z" stroke-width="0" stroke="currentColor" />
                                                          </svg>
                                                      </button>
                                                  </td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                                  <div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
                                      <div class="modal-dialog">
                                          <div class="modal-content">
                                              <form id="bookForm" enctype="multipart/form-data">
                                                  <div class="modal-header">
                                                      <h5 class="modal-title" id="bookModalLabel">
                                                          Add book
                                                      </h5>
                                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                          <span aria-hidden="true">&times;</span>
                                                      </button>
                                                  </div>

                                                  <div class="modal-body">
                                                      <div class="d-flex justify-content-between">
                                                          <div class="mb-3">
                                                              <label for="title" class="form-label">Title</label>
                                                              <input type="text" class="form-control" id="Title" required />
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="Summary" class="form-label">Summary</label>
                                                              <textarea class="form-control" id="Summary" required></textarea>
                                                          </div>
                                                      </div>
                                                      <div class="d-flex justify-content-between">
                                                          <div class="mb-3">
                                                              <label for="price" class="form-label">Price</label>
                                                              <input type="number" class="form-control" id="price" required />
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="quantity" class="form-label">Quantity</label>
                                                              <input type="number" class="form-control" id="quantity" required />
                                                          </div>
                                                      </div>
                                                      <div class="d-flex justify-content-between form-row">
                                                          <div class="mb-3">
                                                              <label for="isbn" class="form-label">ISBN</label>
                                                              <input type="text" class="form-control" id="ISBN" required />
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="format" class="form-label">Format</label>
                                                              <input type="text" class="form-control" id="format" required />
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="language" class="form-label">Language</label>
                                                              <input type="text" class="form-control" id="language" required />
                                                          </div>
                                                      </div>
                                                      <div class="d-flex justify-content-between form-row">
                                                          <div class="mb-3">
                                                              <label for="Publisher" class="form-label">Publisher</label>
                                                              <select class="form-control" id="PublisherSelect" name="PublisherId">
                                                                  <option value="">Select Publisher</option>
                                                                  <option value="publisherID1">Publisher Name 1</option>
                                                                  <option value="publisherID2">Publisher Name 2</option>
                                                                  <option value="publisherID3">Publisher Name 3</option>
                                                              </select>
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="PublisherName" class="form-label">Publisher</label>
                                                              <input class="form-control" id="PublisherName" name="PublisherName" />
                                                                 
                                                            
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="Author" class="form-label">Author</label>
                                                              <select class="form-control" id="AuthorSelect" name="Authors" mutiple>
                                                                  <option value="">Select Author</option>
                                                                  <option value="authorID1">Author Name 1</option>
                                                                  <option value="authorID2">Author Name 2</option>
                                                                  <option value="authorID3">Author Name 3</option>
                                                              </select>
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="publicationDate" class="form-label">Published Date</label>
                                                              <input type="date"
                                                                     class="form-control"
                                                                     id="publicationDate"
                                                                     required />
                                                          </div>
                                                      </div>
                                                      <div class="d-flex justify-content-between">
                                                          <div class="mb-3">
                                                              <label for="genre" class="form-label">Genre</label>
                                                              <input id="genre" class="form-control" name="Genres" />
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="category" class="form-label">Category</label>
                                                              <input id="category" class="form-control" name="Category" />
                                                          </div>
                                                      </div>
                                                      <div class="d-flex justify-content-between mb-3">
                                                          <label for="ImageFile" class="form-label">Images</label>
                                                          <input type="file" id="ImageFile" class="form-control" accept="image/*" name="ImageFile" />
                                                      </div>
                                                      <div class="form-check mb-3">
                                                          <input type="checkbox" class="form-check-input" id="onSaleCheckbox" name="OnSale" />
                                                          <label class="form-check-label" for="onSaleCheckbox">On Sale?</label>
                                                      </div>
                                                      <div id="saleFields" style="display: none">
                                                          <div class="mb-3">
                                                              <label for="salePercentage" class="form-label">Percentage</label>
                                                              <input type="number" class="form-control" id="salePercentage" name="SalePercentage" min="0" max="100" placeholder="Enter Sale Percentage" />
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="saleStartDate" class="form-label">Start Date</label>
                                                              <input type="date" class="form-control" id="saleStartDate" name="SaleStartDate" />
                                                          </div>
                                                          <div class="mb-3">
                                                              <label for="saleEndDate" class="form-label">End Date</label>
                                                              <input type="date" class="form-control" id="saleEndDate" name="SaleEndDate" />
                                                          </div>
                                                      </div>
                                                  </div>
                                                  <div class="modal-footer">
                                                      <button type="button" class="btn btn-secondary" data-dismiss="modal"> Cancel </button>
                                                      <button type="submit" class="btn btn-success">Save </button>
                                                  </div>
                                              </form>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
      <script>
          const editSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                  <path fill="currentColor" d="M15.748 2.947a2 2 0 0 1 2.828 0l2.475 2.475a2 2 0 0 1 0 2.829L9.158 20.144l-6.38 1.076l1.077-6.38zm-.229 3.057l2.475 2.475l1.643-1.643l-2.475-2.474zm1.06 3.89l-2.474-2.475l-8.384 8.384l-.503 2.977l2.977-.502z"/>
                                  </svg>`;

          const saveSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M20.285 6.709l-11.2 11.2l-5.657-5.657L5.8 10.88l3.286 3.285L18.17 5.08z"/>
                                  </svg>`;
          // Fetch and display books
          async function fetchBooks() {
              try {
                  const response = await fetch("https://localhost:44351/api/allBooks", {
                      method: "GET",
                      headers: {
                          "Authorization": `Bearer ${localStorage.getItem("jwtToken")}`
                      }
                  });
                  if (!response.ok) {
                      throw new Error(`Failed to fetch books: ${response.status}`);
                  }
                  const books = await response.json();
                  updateBookTable(books);
              } catch (error) {
                  console.error("Error fetching books:", error);
                  alert("Failed to load books.");
              }
          }

          // Update table with books
          function updateBookTable(data) { // Renamed 'books' to 'data' for clarity
              const tbody = document.querySelector(".bookTable tbody");
              tbody.innerHTML = ""; // Clear existing rows

              if (data && data.$values && Array.isArray(data.$values)) {
                  data.$values.forEach(book => {
                      const row = document.createElement("tr");
                      row.innerHTML = `
                <td>${book.bookId}</td>
                <td>${book.title}</td>
                <td>${book.summary}</td>
                <td>${book.isbn}</td>
                <td>${book.price}</td>
                <td>${book.language}</td>
                <td>${book.format}</td>
                <td>${new Date(book.publicationDate).toLocaleDateString()}</td>
                <td>${book.quantity}</td>
                <td>${book.onSale ? "Yes" : "No"}</td>
                <td>${book.salePercntage || "N/A"}</td>
                <td>${book.saleStartDate ? new Date(book.saleStartDate).toLocaleDateString() : "N/A"}</td>
                <td>${book.category || "N/A"}</td>
                <td><img src="/${book.image}" alt="${book.title}" width="50" onerror="this.src='placeholder.jpg';" /></td>
                <td>${book.publisher ? book.publisher.name : "N/A"}</td>
                <td>${book.authors && book.authors.$values ? book.authors.$values.map(a => `${a.firstName} ${a.lastName}`).join(", ") : "N/A"}</td>
                <td>${book.genres && book.genres.$values ? book.genres.$values.map(g => g.name).join(", ") : "N/A"}</td>
                <td class="actionBtns d-flex justify-content-between">
                    <button class="edit-Btn">${editSVG}</button>
                    <button onclick="deleteBook('${book.bookId}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z" stroke-width="0" stroke="currentColor" />
                        </svg>
                    </button>
                </td>
            `;
                      tbody.appendChild(row);
                  });
                  // Re-attach edit button event listeners
                  attachEditListeners();
              } else {
                  console.error("Error: Invalid book data received from the API", data);
                  // Optionally display a message to the user that book data couldn't be loaded properly
              }
          }

          // Delete book
          async function deleteBook(bookId) {
              if (!confirm("Are you sure you want to delete this book?")) return;
              try {
                  const response = await fetch(`https://localhost:44351/api/deleteBooks/${bookId}`, {
                      method: "DELETE",
                      headers: {
                          "Authorization": `Bearer ${localStorage.getItem("jwtToken")}`
                      }
                  });
                  if (response.ok) {
                      alert("Book deleted successfully!");
                      fetchBooks(); // Refresh table
                  } else {
                      throw new Error("Failed to delete book");
                  }
              } catch (error) {
                  console.error("Error deleting book:", error);
                  alert("Failed to delete book.");
              }
          }

          // Attach edit button listeners
          function attachEditListeners() {
              let currentlyEditingRow = null;

              document.querySelectorAll(".edit-Btn").forEach((editBtn) => {
                  editBtn.addEventListener("click", function () {
                      const row = this.closest("tr");

                      if (currentlyEditingRow && currentlyEditingRow !== row) {
                          toggleEditMode(currentlyEditingRow, false);
                      }

                      const isEditing = row.classList.contains("editing");

                      if (!isEditing) {
                          toggleEditMode(row, true);
                          currentlyEditingRow = row;
                      } else {
                          toggleEditMode(row, false);
                          currentlyEditingRow = null;
                      }
                  });
              });

              function toggleEditMode(row, enable) {
                  const editBtn = row.querySelector(".edit-Btn");
                  row.classList.toggle("editing", enable);

                  Array.from(row.children).forEach((cell, index) => {
                      if (index !== 0 && index !== row.children.length - 1) {
                          if (enable) {
                              const value = cell.innerText;
                              cell.setAttribute("data-original", value);
                              cell.innerHTML = `<input type="text" class="form-control" value="${value}" />`;
                          } else {
                              const input = cell.querySelector("input");
                              if (input) {
                                  cell.textContent = input.value;
                              }
                          }
                      }
                  });

                  editBtn.innerHTML = enable ? saveSVG : editSVG;
              }
          }
          
          // Initialize table on page load
          document.addEventListener("DOMContentLoaded", function () {
              fetchBooks(); // Load books initially

              document.getElementById("bookForm").addEventListener("submit", async function (e) {
                  
                  e.preventDefault();

                  const formData = new FormData();
                  formData.append("Title", document.getElementById("Title").value);
                  formData.append("Summary", document.getElementById("Summary").value);
                  formData.append("ISBN", document.getElementById("ISBN").value);
                  formData.append("Price", document.getElementById("price").value);
                  formData.append("Quantity", document.getElementById("quantity").value);
                  formData.append("Format", document.getElementById("format").value);
                  formData.append("Language", document.getElementById("language").value);
                  const publicationDateInput = document.getElementById("publicationDate").value;
                  if (publicationDateInput) {
                      formData.append("PublicationDate", `${publicationDateInput}T00:00:00Z`);
                  }

                  formData.append("Category", document.getElementById("category").value);
                  formData.append("OnSale", document.getElementById("onSaleCheckbox").checked);

                  const publisherSelect = document.querySelector('select[for="Publisher"]');
                  if (publisherSelect && publisherSelect.value) {
                      formData.append("PublisherId", publisherSelect.value);
                  }
                  formData.append("PublisherName", document.getElementById("PublisherName").value);

                  const authorSelect = document.querySelector('#AuthorSelect');
                  if (authorSelect && authorSelect.selectedOptions) {
                      const authorIds = Array.from(authorSelect.selectedOptions).map(option => option.value);
                      authorIds.forEach(authorId => {
                          formData.append("Authors", authorId); // Append each selected ID
                      });
                  }

                  const genreInput = document.getElementById("genre").value;
                  if (genreInput) {
                      genreInput.split(",").forEach(genre => formData.append("Genres", genre.trim()));
                  }

                  if (document.getElementById("onSaleCheckbox").checked) {
                      formData.append("SalePercentage", document.getElementById("salePercentage").value);
                      formData.append("SaleStartDate", document.getElementById("saleStartDate").value);
                      formData.append("SaleEndDate", document.getElementById("saleEndDate").value);
                  }

                  const imageInput = document.getElementById("ImageFile");
                  if (imageInput.files.length > 0) {
                      formData.append("ImageFile", imageInput.files[0]);
                  }

                  console.log("Book Data:", Object.fromEntries(formData));

                  try {
                      const response = await fetch("https://localhost:44351/api/addBooks", {
                          method: "POST",
                          headers: {
                              "Authorization": `Bearer ${localStorage.getItem("jwtToken")}`
                          },
                          body: formData
                      });

                      if (response.ok) {
                          const result = await response.json();
                          alert("Book added successfully!");
                          $("#bookModal").modal("hide");
                          this.reset();
                          fetchBooks(); // Refresh table
                      } else {
                          const error = await response.json();
                          alert(`Failed to add book: ${error.message || "Unknown error"}`);
                      }
                  } catch (error) {
                      console.error("Error:", error);
                      alert("An error occurred while adding the book.");
                  }
              });

              document.getElementById("onSaleCheckbox").addEventListener("change", function () {
                  const saleFields = document.getElementById("saleFields");
                  if (this.checked) {
                      saleFields.style.display = "flex";
                      saleFields.style.alignItems = "center";
                      saleFields.classList.add("form-row");
                  } else {
                      saleFields.style.display = "none";
                      document.getElementById("salePercentage").value = "";
                      document.getElementById("saleStartDate").value = "";
                      document.getElementById("saleEndDate").value = "";
                  }
              });
          });
      </script>
  </body>
</html>
